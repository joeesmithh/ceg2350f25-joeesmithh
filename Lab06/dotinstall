#!/usr/bin/env bash

alias_file=".bash_aliases"
alias_path="$PWD/$alias_file"
sym_path="$HOME/$alias_file"

printHelp() {
	echo "Usage: dotinstall [-OPTION] [ARG]"
  	echo "  -s setup - attempts to create a symbolic link .bash_aliases file to user's home directory"
  	echo "  -d disconnect - removes symbolic link"
  	echo "  -a append - adds a new alias to .bash_aliases file"
  	echo "  -r remove - removes an alias from .bash_aliases file"
}

reloadPrompt() {
	printf "User should reload the shell with 'source ~/.bashrc'\n"
}

promptYesNo () {
	read -p "Input (Y/N): " choice
	while [[ ! $choice =~ [yYnN] ]]; do
		printf -v error "Invalid option!"
		read -p "$error Input (Y/N): " choice
	done

	echo "$choice"
}

formSymlink() {
	(ln -s $alias_path "$sym_path")
	echo "Created symlink $sym_path"
}

createSymlink () {
	# If .bash_aliases exists in home directory
	if [[ -e "$sym_path" ]]; then

		# Prompt for overwrite
		echo "$alias_file already exists! Overwrite?"
		if [[ "$(promptYesNo)" =~ [yY] ]]; then
			breakSymlink 	# Remove old link
			formSymlink		# Form new link
			reloadPrompt
		fi
	else
		formSymlink
		reloadPrompt
	fi
}

breakSymlink() {
	# Force delete to avoid error output
	(rm -f "$sym_path")
	echo "Removed symlink $sym_path"
}

validateAlias () {
	local string=""
	if [[ $1 =~ ^alias[[:space:]]+[[:alnum:]]+\=\".+\"$ ]]; then
		string="$1"
	fi

	echo "$string" # Return empty string if invalid
}

addAlias () {

	string="$(validateAlias "$1")"
	if [[ -n $string ]]; then
		# TODO: check whether an alias with the same name is already present in .bash_aliases
		echo "$string"
		(echo "$string" >> "$alias_path")
	else
		echo 'Invalid alias declaration of form "alias [name]="[command]"'
	fi
}

removeAlias() {
	echo $1
}


no_args="true"

# Evaluate options
while getopts ":sda:r:" opt; do
	case $opt in
		s) createSymlink ;;
		d) breakSymlink ;;
		a) addAlias "$OPTARG" ;;
		r) removeAlias "$OPTARG";;
		:) echo "An argument must follow option -$OPTARG"; printHelp;;
		\?) echo "Option not supported!"; printHelp;;
	esac
	no_args="false"
done

# Output error message and command usage if no args passed
if [[ "$no_args" == "true" ]]; then
	echo "No options specified!"
	printHelp
fi
